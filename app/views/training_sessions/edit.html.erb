<h1>トレーニング記録の編集</h1>

<%= form_with(model: @training_session, local: true, data: { turbo: false }, html: { id: 'training-session-form' }) do |form| %>
  <div class="col-md-10 col-lg-8 mx-auto">
    <%= render 'shared/error_messages', object: @training_session %>

    <div class="field">
      <%= form.label :date, "日付" %>
      <%= form.date_field :date %>
    </div>

    <h3>エクササイズ</h3>
    <div id="exercises-container">
      <% @training_session.session_exercises.each_with_index do |session_exercise, i| %>
        <div class="exercise-row" data-index="<%= i %>">
          <%= form.label :name, "種目 #{i + 1}" %>
          <%= form.collection_select :name, Exercise.all, :name, :name, { prompt: "種目を選択" }, { name: "training_session[session_exercises_attributes][#{i}][name]" } %>
          <%= form.label :weight, "重量" %>
          <%= form.number_field :weight, name: "training_session[session_exercises_attributes][#{i}][weight]", placeholder: "重量(kg)" %>
          <%= form.label :reps, "回数" %>
          <%= form.number_field :reps, name: "training_session[session_exercises_attributes][#{i}][reps]", placeholder: "回数" %>
          <%= button_to '削除', '', class: 'remove_exercise', data: { exercise_id: session_exercise.id } %>
        </div>
      <% end %>
    </div>

    <div class="actions">
      <%= form.submit "更新" %>
    </div>
  <% end %>
  <%= link_to '戻る', training_sessions_path %>

<button type="button" id="add-exercise">エクササイズを追加</button>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // CSRFトークンをセットアップ
  $.ajaxSetup({
    headers: {
      'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
    }
  });

  const exercisesContainer = document.getElementById('exercises-container');
  const addExerciseButton = document.getElementById('add-exercise');

  addExerciseButton.addEventListener('click', function(event) {
    event.preventDefault(); // ボタンのデフォルト動作を防止
    const newIndex = exercisesContainer.children.length;
    const newExerciseHTML = `
      <div class="exercise-row" data-index="${newIndex}">
        <label for="training_session_session_exercises_attributes_${newIndex}_name">種目 ${newIndex + 1}</label>
        <select id="training_session_session_exercises_attributes_${newIndex}_name" name="training_session[session_exercises_attributes][${newIndex}][name]">
          <option value="">種目を選択</option>
        </select>
        <label for="training_session_session_exercises_attributes_${newIndex}_weight">重量</label>
        <input type="number" id="training_session_session_exercises_attributes_${newIndex}_weight" name="training_session[session_exercises_attributes][${newIndex}][weight]" placeholder="重量(kg)">
        <label for="training_session_session_exercises_attributes_${newIndex}_reps">回数</label>
        <input type="number" id="training_session_session_exercises_attributes_${newIndex}_reps" name="training_session[session_exercises_attributes][${newIndex}][reps]" placeholder="回数">
        <button type="button" class="remove_exercise" onclick="removeExercise(this)">削除</button>
      </div>
    `;
    exercisesContainer.insertAdjacentHTML('beforeend', newExerciseHTML);
  });

  document.addEventListener('click', function(event) {
    if (event.target.classList.contains('remove_exercise')) {
      event.preventDefault();
      const exerciseRow = event.target.closest('.exercise-row');
      exerciseRow.remove();
    }
  });
});
</script>